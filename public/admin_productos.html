<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AdministraciÃ³n de Productos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body{display:flex;flex-direction:column;min-height:100vh;padding-bottom:60px;background:#f8f9fa}
    main{flex:1}
    footer{position:fixed;bottom:0;width:100%}
    .product-card{border:1px solid #ddd;border-radius:.5rem;padding:10px;text-align:center}
    .product-card-img{width:100%;height:100px;object-fit:cover;margin-bottom:8px}
  </style>
</head>
<body>
  
  <!--Navbar-->
  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="inicio.html">ğ™¼ğšğšğš’ğšğšğš›ğš›ğšŠğš—ğšğš˜</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" href="catalogo.html">CatÃ¡logo</a></li>
          <li class="nav-item"><a class="nav-link" href="sobre_nosotros.html">Acerca de nosotros</a></li>
        </ul>

        <ul class="navbar-nav ms-auto">

          <li class="nav-item me-3">
            <a class="nav-link" href="carrito.html" title="Ver Pedido">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-cart" viewBox="0 0 16 16">
                <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.485-.379L1.71 5.438a.5.5 0 0 1-.485-.379L.105 1.562A.5.5 0 0 1 0 1.5zm1.115 3.5h12.77L13 5H3.19zM4 14a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm10 0a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
              </svg>
            </a>
          </li>

          <li id="session-nav" class="nav-item dropdown"></li>

        </ul>
      </div>
    </div>
  </nav>

  <!--CONTENIDO PRINCIPAL -->
  <main class="container my-5">
    <h1 class="mb-4">AdministraciÃ³n de Productos</h1>

    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="add-tab" data-bs-toggle="tab" data-bs-target="#addProduct" type="button" role="tab">Agregar producto</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="modify-tab" data-bs-toggle="tab" data-bs-target="#modifyProduct" type="button" role="tab">Eliminar / Modificar productos</button>
      </li>
    </ul>

    <div class="tab-content border border-top-0 p-3 bg-white shadow-sm">

      <!--AGREGAR PRODUCTO -->
      <div class="tab-pane fade show active" id="addProduct" role="tabpanel">
        <h3 class="mb-3">Agregar nuevo producto</h3>
        <div class="row g-3">
          <div class="col-lg-6">
            <input id="add-name" type="text" class="form-control" placeholder="Nombre. Ej: Paella MediterrÃ¡nea" required>
          </div>
          <div class="col-lg-3">
            <select id="add-category" class="form-select" required>
              <option value="Plato" selected>Plato</option>
              <option value="Entrada">Entrada</option>
              <option value="Postre">Postre</option>
              <option value="Bebida">Bebida</option>
            </select>
          </div>
          <div class="col-lg-3">
            <input id="add-price" type="number" class="form-control" placeholder="Precio base (Ej: 12990)" min="0" required>
          </div>

          <div class="col-12">
            <label for="productDescription" class="form-label">DescripciÃ³n del plato</label>
            <textarea id="add-description" class="form-control" rows="3" placeholder="Describe el producto..."></textarea>
          </div>

          <!-- VARIANTES -->
          <div class="col-12">
            <label class="form-label">Variantes del producto</label>
            <div id="variantList" class="mb-3"></div>
            <div class="input-group mb-2">
              <input type="text" class="form-control" id="variantNameInput" placeholder="Nombre variante (Ej: Individual)">
              <input type="number" class="form-control" id="variantPriceInput" placeholder="Precio (Ej: 4500)" min="0" step="100">
              <input type="number" class="form-control" id="variantStockInput" placeholder="Stock (Ej: 15)" min="0">
              <button class="btn btn-outline-primary" type="button" id="addVariantBtn">Agregar</button>
            </div>
            <small class="text-muted">Opcional: si no agregas variantes, se usarÃ¡ solo el precio base.</small>
          </div>

          <div class="col-lg-9">
            <input id="add-image" type="text" class="form-control" placeholder="URL imagen (ej: img/paella.jpg)">
          </div>
          <div class="col-lg-3 d-grid">
            <button id="btn-save" class="btn btn-primary btn-lg">Guardar producto</button>
          </div>

          <div class="col-12"><small id="add-msg" class="text-muted"></small></div>
        </div>
      </div>

      <!-- ğŸ”µ MODIFICAR / ELIMINAR -->
      <div class="tab-pane fade" id="modifyProduct" role="tabpanel">
        <h3 class="mb-4">CatÃ¡logo de productos</h3>
        <div id="grid-products" class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3"></div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="bg-dark text-white text-center p-3">
    Â© 2025 Mediterraneo
  </footer>

  <script>
    const api = '/api/menu';

    // helpers
    const slugify = s => s.toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)+/g,'');
    const money = n => '$' + Number(n||0).toLocaleString('es-CL');

    // refs
    const $addName = document.getElementById('add-name');
    const $addCategory = document.getElementById('add-category');
    const $addPrice = document.getElementById('add-price');
    const $addDesc = document.getElementById('add-description');
    const $addImg = document.getElementById('add-image');
    const $addMsg = document.getElementById('add-msg');
    const $btnSave = document.getElementById('btn-save');
    const $grid = document.getElementById('grid-products');

    // variantes UI
    const variantList = document.getElementById('variantList');
    const addVariantBtn = document.getElementById('addVariantBtn');
    const variantNameInput = document.getElementById('variantNameInput');
    const variantPriceInput = document.getElementById('variantPriceInput');
    const variantStockInput = document.getElementById('variantStockInput');

    addVariantBtn.addEventListener('click', () => {
      const name = variantNameInput.value.trim();
      const price = Number(variantPriceInput.value);
      const stock = Number(variantStockInput.value);
      if(!name || isNaN(price) || price<0 || isNaN(stock) || stock<0){
        alert('Ingrese nombre, precio y stock vÃ¡lidos.'); return;
      }
      const div = document.createElement('div');
      div.className = 'd-flex justify-content-between align-items-center border p-2 rounded mb-2';
      div.innerHTML = `
        <span><strong>${name}</strong> â€” Precio: ${money(price)} â€” Stock: ${stock}</span>
        <div>
          <button class="btn btn-sm btn-outline-secondary me-2" data-action="edit-variant">Editar</button>
          <button class="btn btn-sm btn-danger" data-action="remove-variant">Eliminar</button>
        </div>
        <input type="hidden" name="variants[]" value="${name}|${price}|${stock}">
      `;
      variantList.appendChild(div);
      variantNameInput.value = ''; variantPriceInput.value = ''; variantStockInput.value = '';
      div.querySelector('[data-action="remove-variant"]').onclick = () => div.remove();
      div.querySelector('[data-action="edit-variant"]').onclick = () => {
        const [n,p,s] = div.querySelector('input[name="variants[]"]').value.split('|');
        variantNameInput.value = n; variantPriceInput.value = p; variantStockInput.value = s;
        div.remove();
      };
    });

    function gatherVariants(){
      return Array.from(document.querySelectorAll('input[name="variants[]"]'))
        .map(i => { const [name, price, stock] = i.value.split('|'); return { name, price: Number(price), stock: Number(stock) }; });
    }

    // save (POST)
    $btnSave.addEventListener('click', async ()=>{
    const body = {
        name: $addName.value.trim(),
        slug: slugify($addName.value),
        category: $addCategory.value,
        price: Number($addPrice.value),
        description: $addDesc.value.trim(),
        image: $addImg.value.trim(),
        variants: gatherVariants()
    };
    try{
        const res = await fetch(api, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
        });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

        $addMsg.textContent = 'âœ” Producto agregado';
        [$addName,$addPrice,$addDesc,$addImg].forEach(i=> i.value='');
        variantList.innerHTML = '';
        await loadProducts();
        setTimeout(()=> $addMsg.textContent='', 1500);
    }catch(e){
        $addMsg.textContent = 'âœ– ' + e.message;
    }
    });

    async function loadProducts(){
      const res = await fetch(api);
      const items = await res.json();
      $grid.innerHTML = items.map(p => `
        <div class="col">
          <div class="product-card">
            <img src="${p.image || 'img/placeholder.jpg'}" class="product-card-img rounded" alt="${p.name}">
            <p class="mb-1 fw-bold">${p.name}</p>
            <small class="d-block text-muted">${p.category} â€¢ ${money(p.price)}</small>
            ${p.variants?.length ? `<small class="d-block text-muted">Variantes: ${p.variants.length}</small>` : ''}
            <div class="d-grid gap-1 mt-2">
              <button class="btn btn-sm btn-info" data-action="edit" data-id="${p._id}">Modificar</button>
              <button class="btn btn-sm btn-danger" data-action="del" data-id="${p._id}">Eliminar</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // acciones editar/eliminar
    $grid.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const id = btn.dataset.id;

      if(btn.dataset.action === 'del'){
        if(!confirm('Â¿Eliminar este producto?')) return;
        const res = await fetch(`${api}/${id}`, { method:'DELETE' });
        if(!res.ok) return alert('Error al eliminar');
        await loadProducts();
        return;
      }

      if(btn.dataset.action === 'edit'){
        // cargar datos, ponerlos arriba y guardar con PUT
        const res = await fetch(api); const items = await res.json();
        const p = items.find(x=> x._id === id);
        if(!p) return alert('No encontrado');

        // set valores en el tab "Agregar" para reutilizar
        document.querySelector('[data-bs-target="#addProduct"]').click();
        $addName.value = p.name;
        $addCategory.value = p.category;
        $addPrice.value = p.price;
        $addDesc.value = p.description || '';
        $addImg.value = p.image || '';
        variantList.innerHTML = '';
        (p.variants || []).forEach(v=>{
          const hidden = document.createElement('input');
          hidden.type='hidden'; hidden.name='variants[]'; hidden.value = `${v.name}|${v.price}|${v.stock}`;
          const div = document.createElement('div');
          div.className = 'd-flex justify-content-between align-items-center border p-2 rounded mb-2';
          div.innerHTML = `
            <span><strong>${v.name}</strong> â€” Precio: ${money(v.price)} â€” Stock: ${v.stock}</span>
            <div>
              <button class="btn btn-sm btn-outline-secondary me-2" data-action="edit-variant">Editar</button>
              <button class="btn btn-sm btn-danger" data-action="remove-variant">Eliminar</button>
            </div>
          `;
          div.appendChild(hidden);
          variantList.appendChild(div);
          div.querySelector('[data-action="remove-variant"]').onclick = () => div.remove();
          div.querySelector('[data-action="edit-variant"]').onclick = () => {
            const [n,pv,sv] = hidden.value.split('|');
            variantNameInput.value = n; variantPriceInput.value = pv; variantStockInput.value = sv;
            div.remove();
          };
        });

        // cambiar el botÃ³n Guardar a modo UPDATE temporalmente
        const originalText = $btnSave.textContent;
        $btnSave.textContent = 'Guardar cambios';
        const handler = async ()=>{
          const body = {
            name: $addName.value.trim(),
            slug: slugify($addName.value),
            category: $addCategory.value,
            price: Number($addPrice.value),
            description: $addDesc.value.trim(),
            image: $addImg.value.trim(),
            variants: gatherVariants()
          };
          const r = await fetch(`${api}/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
          if(!r.ok) return alert('Error al actualizar');
          $btnSave.textContent = originalText;
          $btnSave.removeEventListener('click', handler);
          [$addName,$addPrice,$addDesc,$addImg].forEach(i=> i.value='');
          variantList.innerHTML = '';
          await loadProducts();
        };
        $btnSave.addEventListener('click', handler, { once:true });
      }
    });

    // init
    loadProducts();
  </script>

<script src="js/session.js"></script>

</body>
</html>
