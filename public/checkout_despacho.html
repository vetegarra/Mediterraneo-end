<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado y Seguimiento | Mediterraneo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* CorrecciÃ³n: Navbar fijo arriba y padding para que el contenido no quede debajo */
        body {
            padding-top: 56px; /* Ajuste basado en la altura estÃ¡ndar del navbar de Bootstrap */
            background-color: #f8f9fa;
        }
        .navbar-dark {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1030;
        }
        .card-step {
            min-height: 250px;
        }
    </style>
</head>
<body>

<!--Navbar-->
  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="inicio.html">ğ™¼ğšğšğš’ğšğšğš›ğš›ğšŠğš—ğšğš˜</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="collapsibleNavbar">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" href="catalogo.html">CatÃ¡logo</a></li>
          <li class="nav-item"><a class="nav-link" href="sobre_nosotros.html">Acerca de nosotros</a></li>
        </ul>

        <ul class="navbar-nav ms-auto">

          <li class="nav-item me-3">
            <a class="nav-link" href="carrito.html" title="Ver Pedido">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-cart" viewBox="0 0 16 16">
                <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.485-.379L1.71 5.438a.5.5 0 0 1-.485-.379L.105 1.562A.5.5 0 0 1 0 1.5zm1.115 3.5h12.77L13 5H3.19zM4 14a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm10 0a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
              </svg>
            </a>
          </li>

          <li id="session-nav" class="nav-item dropdown"></li>

        </ul>
      </div>
    </div>
  </nav>

<div class="container py-5">
    <h1 class="mb-5 text-center text-info">Estado de Reparto y Seguimiento</h1>

    <div id="seguimientoPedido" class="card shadow-lg mb-4 card-step">
        <div class="card-header bg-info text-white">
            <h4 class="mb-0">Pedido ID: 3645 - Pendiente de ConfirmaciÃ³n ğŸ•’</h4>
        </div>
        <div class="card-body">
            <div id="alertaCancelacion" class="alert alert-warning fw-bold text-center">
                Tienes <span id="timerDisplay" class="fw-bolder fs-5 text-danger">3:00</span> minutos para cancelar el pedido.
            </div>
            
            <p class="mb-2 fs-5">DirecciÃ³n de EnvÃ­o: <span class="fw-bold" id="seguimientoDireccion">Cargando DirecciÃ³n...</span></p>
            <p class="mb-2 fs-5">Chofer: <span class="fw-bold text-muted" id="choferAsignado">Pendiente de AsignaciÃ³n</span></p>
            <p class="mb-2 fs-5">Horario estimado: <span class="fw-bold text-muted" id="horarioEstimado">Pendiente de ConfirmaciÃ³n</span></p>
            
            <label for="progressBar" class="form-label mt-3">Progreso del Despacho</label>
            <div class="progress" role="progressbar" aria-label="Progreso del Despacho" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 30px;">
                <div class="progress-bar bg-warning" id="progressBar" style="width: 0%">0% - Pendiente de ConfirmaciÃ³n</div>
            </div>

            <hr class="my-4">

            <div class="d-grid gap-2">
                <button class="btn btn-danger btn-lg" type="button" id="btnCancelarPedido">
                    âŒ Cancelar Pedido (Tiempo restante: <span id="timerButton">3:00</span>)
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const seguimientoDireccion = document.getElementById('seguimientoDireccion');
        const btnCancelarPedido = document.getElementById('btnCancelarPedido');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerButton = document.getElementById('timerButton');
        const progressBar = document.getElementById('progressBar');

        // --- LÃ“GICA DE SIMULACIÃ“N DE DIRECCIÃ“N ---
        const urlParams = new URLSearchParams(window.location.search);
        const dir = urlParams.get('dir');

        if (dir) {
            seguimientoDireccion.textContent = decodeURIComponent(dir);
        } else {
            seguimientoDireccion.textContent = "Av. completo rico 2, santiago (SimulaciÃ³n)"; 
        }

        // --- LÃ“GICA DEL TEMPORIZADOR DE CANCELACIÃ“N ---
        let timeRemaining = 180; // 3 minutos en segundos

        function updateTimer() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            timerDisplay.textContent = timeString;
            timerButton.textContent = timeString;

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                btnCancelarPedido.disabled = true;
                btnCancelarPedido.textContent = "CancelaciÃ³n no permitida (Tiempo expirado)";
                
                // Opcional: Cambiar la barra de progreso a un estado de 'preparaciÃ³n' despuÃ©s del tiempo lÃ­mite.
                progressBar.style.width = '10%';
                progressBar.textContent = '10% - En preparaciÃ³n';
                progressBar.classList.remove('bg-warning');
                progressBar.classList.add('bg-success');
                
                document.getElementById('alertaCancelacion').classList.remove('alert-warning');
                document.getElementById('alertaCancelacion').classList.add('alert-success');
                document.getElementById('alertaCancelacion').innerHTML = 'âœ… Pedido confirmado y en preparaciÃ³n. Ya no es posible cancelarlo.';

            } else {
                timeRemaining--;
            }
        }

        // Iniciar el temporizador cada segundo
        const timerInterval = setInterval(updateTimer, 1000);

        // --- LÃ“GICA DE CANCELACIÃ“N DEL BOTÃ“N ---
        btnCancelarPedido.addEventListener('click', function() {
            if (confirm("Â¿EstÃ¡s seguro de que deseas cancelar el pedido? Esta acciÃ³n no se puede deshacer.")) {
                clearInterval(timerInterval);
                btnCancelarPedido.disabled = true;
                btnCancelarPedido.textContent = "Pedido Cancelado Exitosamente";
                btnCancelarPedido.classList.remove('btn-danger');
                btnCancelarPedido.classList.add('btn-secondary');

                document.getElementById('alertaCancelacion').classList.remove('alert-warning');
                document.getElementById('alertaCancelacion').classList.add('alert-danger');
                document.getElementById('alertaCancelacion').innerHTML = 'ğŸ”´ El pedido ha sido cancelado.';
                
                // Opcional: Cambiar la barra de progreso
                progressBar.style.width = '100%';
                progressBar.textContent = 'Cancelado';
                progressBar.classList.remove('bg-warning');
                progressBar.classList.add('bg-danger');

                // AquÃ­ irÃ­a el cÃ³digo real para notificar al servidor sobre la cancelaciÃ³n
                alert("Pedido cancelado.");
            }
        });

    });
</script>

<script src="js/session.js"></script>

</body>
</html>